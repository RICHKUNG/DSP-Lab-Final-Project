# ECG Pulse Runner - æ•´åˆç³»çµ±èªªæ˜

**DSP æœŸæœ«å°ˆæ¡ˆ - å¿ƒé›»åœ–è·‘é…·éŠæˆ²**

æ•´åˆèªéŸ³è¾¨è­˜ + ECG è¨Šè™Ÿè™•ç† + ç¶²é éŠæˆ²çš„å³æ™‚äº’å‹•ç³»çµ±

---

## ğŸ¯ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VoiceControl â”‚     â”‚  ECGManager  â”‚     â”‚  GameServer  â”‚
â”‚  (èªéŸ³è¾¨è­˜)   â”‚     â”‚  (å¿ƒé›»è¨Šè™Ÿ)   â”‚     â”‚  (ç¶²é éŠæˆ²)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â”‚   publish events   â”‚   publish events   â”‚   subscribe
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ EventBus â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ emit via SocketIO
                            â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Browser  â”‚
                      â”‚  (éŠæˆ²)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒè¨­å®š

```bash
# ä½¿ç”¨ conda ç’°å¢ƒ
conda env create -f dspfp_env.yml
conda activate dspfp

# æˆ–ä½¿ç”¨ pip
pip install -r requirements.txt
```

### 2. å•Ÿå‹•ç³»çµ±

```bash
# å®Œæ•´ç³»çµ±ï¼ˆECG + èªéŸ³ + éŠæˆ²ï¼‰
python app.py

# æ¸¬è©¦æ¨¡å¼ï¼ˆä¸ä½¿ç”¨ ECGï¼‰
python app.py --no-ecg

# æ¸¬è©¦æ¨¡å¼ï¼ˆä¸ä½¿ç”¨èªéŸ³ï¼‰
python app.py --no-voice

# æŒ‡å®š ECG Port
python app.py --ecg-port COM3

# æŒ‡å®šèªéŸ³è¾¨è­˜æ–¹æ³•
python app.py --voice-method mfcc_dtw    # æœ€å¿« (~160ms)
python app.py --voice-method adaptive_ensemble  # æœ€æº– (97.9%)

# è‡ªè¨‚ç¶²é åŸ è™Ÿ
python app.py --web-port 8080
```

### 3. é–‹å•ŸéŠæˆ²

ç€è¦½å™¨è¨ªå•: `http://localhost:5000`

---

## ğŸ® éŠæˆ²æ§åˆ¶

### èªéŸ³æŒ‡ä»¤

- **é–‹å§‹** - é–‹å§‹éŠæˆ²
- **æš«åœ** - æš«åœ/ç¹¼çºŒ
- **è·³** - è§’è‰²è·³èº

### éµç›¤æ§åˆ¶ï¼ˆå‚™ç”¨ï¼‰

- **â†‘ (ä¸Šç®­é ­)** - è·³èº
- **Space** - æš«åœ/ç¹¼çºŒ

### ECG è¨Šè™Ÿ

- R-R å³°å€¼è‡ªå‹•ç”Ÿæˆéšœç¤™ç‰©
- BPM é¡¯ç¤ºåœ¨éŠæˆ²ç•«é¢ä¸Šæ–¹

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
C:\Users\user\Desktop\DSPLab\Final/
â”œâ”€â”€ app.py                      # ä¸»ç¨‹å¼å…¥å£
â”œâ”€â”€ requirements.txt            # Python å¥—ä»¶
â”œâ”€â”€ dspfp_env.yml              # Conda ç’°å¢ƒ
â”œâ”€â”€ great_merge.md              # æ•´åˆé€²åº¦è¿½è¹¤
â”‚
â”œâ”€â”€ src/                        # åŸå§‹ç¢¼
â”‚   â”œâ”€â”€ event_bus.py           # äº‹ä»¶åŒ¯æµæ’
â”‚   â”‚
â”‚   â”œâ”€â”€ audio/                  # èªéŸ³æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ controller.py      # VoiceController
â”‚   â”‚   â”œâ”€â”€ io.py              # éŸ³è¨Š I/O
â”‚   â”‚   â”œâ”€â”€ vad.py             # èªéŸ³æ´»å‹•æª¢æ¸¬
â”‚   â”‚   â”œâ”€â”€ features.py        # ç‰¹å¾µæå–
â”‚   â”‚   â””â”€â”€ recognizers.py     # è¾¨è­˜å¼•æ“
â”‚   â”‚
â”‚   â”œâ”€â”€ ecg/                    # ECG æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ manager.py         # ECGManager
â”‚   â”‚
â”‚   â””â”€â”€ game/                   # éŠæˆ²æ¨¡çµ„
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ server.py          # Flask + SocketIO
â”‚       â””â”€â”€ templates/
â”‚           â””â”€â”€ index.html     # éŠæˆ²å‰ç«¯
â”‚
â”œâ”€â”€ cmd_templates/              # èªéŸ³æŒ‡ä»¤æ¨¡æ¿
â”œâ”€â”€ tests/                      # æ¸¬è©¦æª”æ¡ˆ
â””â”€â”€ docs/                       # æ–‡ä»¶
```

---

## ğŸ”§ æ¨¡çµ„èªªæ˜

### 1. EventBusï¼ˆäº‹ä»¶åŒ¯æµæ’ï¼‰

- **åŠŸèƒ½**: åŸ·è¡Œç·’å®‰å…¨çš„ pub/sub äº‹ä»¶ç³»çµ±
- **ä½ç½®**: `src/event_bus.py`
- **äº‹ä»¶é¡å‹**:
  - `ECG_PEAK` - R æ³¢å³°å€¼åµæ¸¬
  - `ECG_BPM_UPDATE` - BPM æ›´æ–°
  - `VOICE_COMMAND` - èªéŸ³æŒ‡ä»¤è¾¨è­˜
  - `VOICE_NOISE` - å™ªéŸ³åµæ¸¬
  - `SYSTEM_SHUTDOWN` - ç³»çµ±é—œé–‰

### 2. VoiceControllerï¼ˆèªéŸ³æ§åˆ¶å™¨ï¼‰

- **åŠŸèƒ½**: æ•´åˆéŸ³è¨Šè¼¸å…¥ã€VADã€ç‰¹å¾µæå–ã€è¾¨è­˜
- **ä½ç½®**: `src/audio/controller.py`
- **è¾¨è­˜æ–¹æ³•**:
  - `mfcc_dtw` - åƒ… MFCCï¼ˆæœ€å¿« ~160msï¼‰
  - `ensemble` - å›ºå®šæ¬Šé‡ Ensemble
  - `adaptive_ensemble` - SNR è‡ªé©æ‡‰ï¼ˆé è¨­ï¼Œæœ€æº– 97.9%ï¼‰
- **æº–ç¢ºç‡**: 97.9% (Adaptive Ensemble)
- **æ”¯æ´æŒ‡ä»¤**: START, PAUSE, JUMP

### 3. ECGManagerï¼ˆECG ç®¡ç†å™¨ï¼‰

- **åŠŸèƒ½**: Serial é€šè¨Šã€æ¿¾æ³¢ã€R-R å³°å€¼åµæ¸¬ã€BPM è¨ˆç®—
- **ä½ç½®**: `src/ecg/manager.py`
- **æ¿¾æ³¢éˆ**: MA â†’ å·®åˆ† â†’ å¹³æ–¹ â†’ MWI
- **ç‰¹è‰²**:
  - è‡ªå‹•åµæ¸¬ COM Port
  - Refractory Period (250ms)
  - å‹•æ…‹é–¾å€¼èª¿æ•´
  - R-R é–“éš”æ­·å²å¹³å‡

### 4. GameServerï¼ˆéŠæˆ²ä¼ºæœå™¨ï¼‰

- **åŠŸèƒ½**: Flask ç¶²é ä¼ºæœå™¨ + SocketIO å³æ™‚é€šè¨Š
- **ä½ç½®**: `src/game/server.py`
- **äº‹ä»¶è½‰ç™¼**:
  - `ECG_PEAK` â†’ `spawn_obstacle`
  - `ECG_BPM_UPDATE` â†’ `bpm_update`
  - `VOICE_COMMAND` â†’ `player_action`

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

| æ¨¡çµ„ | ç›®æ¨™ | å¯¦æ¸¬ | ç‹€æ…‹ |
|------|------|------|------|
| ECG æ¿¾æ³¢ | <1ms | - | å¾…æ¸¬ |
| èªéŸ³è¾¨è­˜ (MFCC) | <200ms | ~160ms | âœ… |
| èªéŸ³è¾¨è­˜ (Ensemble) | <300ms | ~270ms | âœ… |
| EventBus | <1ms | <10ms | âœ… |
| ç«¯å°ç«¯ | <500ms | - | å¾…æ¸¬ |

---

## ğŸ”¨ é–‹ç™¼å·¥å…·

### åŸ·è¡Œæ¸¬è©¦

```bash
# å»¶é²åŸºæº–æ¸¬è©¦ï¼ˆå»ºç«‹å¾Œï¼‰
python tests/bench_latency.py

# èªéŸ³æ¨¡çµ„æ¸¬è©¦
python tests/test_voice.py

# ECG æ¨¡çµ„æ¸¬è©¦ï¼ˆéœ€è¦ç¡¬é«”ï¼‰
python tests/test_ecg.py
```

### æŸ¥çœ‹é€²åº¦

æŸ¥çœ‹ `great_merge.md` äº†è§£æ•´åˆé€²åº¦å’Œå·²çŸ¥å•é¡Œ

---

## ğŸ“ æŠ€è¡“ç´°ç¯€

### GIL è™•ç†

- ä½¿ç”¨ NumPy å‘é‡åŒ–æ“ä½œï¼ˆé‡‹æ”¾ GILï¼‰
- é—œéµè¿´åœˆä¸­ä½¿ç”¨ `socketio.sleep(0)`

### å‰å¾Œç«¯åŒæ­¥

- éŠæˆ²é‚è¼¯åœ¨å‰ç«¯ï¼ˆJavaScriptï¼‰
- å¾Œç«¯åƒ…ç™¼é€äº‹ä»¶
- ECG éšœç¤™ç‰©åœ¨å³å´ç”Ÿæˆï¼Œæœ‰ç·©è¡æ™‚é–“

### Import è·¯å¾‘

- éŸ³è¨Šæ¨¡çµ„å·²ç§»è‡³ `src/audio/`
- ç›¸å° import å·²ä¿®æ­£ç‚º `from .. import config`

---

## ğŸ› ç–‘é›£æ’è§£

### æ‰¾ä¸åˆ°éŸ³è¨Šè£ç½®

```bash
# æª¢æŸ¥å¯ç”¨è£ç½®
python scripts/check_audio_devices.py
```

### ECG ç„¡æ³•é€£æ¥

```bash
# æª¢æŸ¥ COM Port
python -m serial.tools.list_ports

# æ‰‹å‹•æŒ‡å®š Port
python app.py --ecg-port COM3
```

### èªéŸ³è¾¨è­˜ä¸æº–ç¢º

```bash
# ä½¿ç”¨ä¸åŒæ–¹æ³•
python app.py --voice-method mfcc_dtw

# é‡æ–°æ ¡æº–ï¼ˆåœ¨å®‰éœç’°å¢ƒå•Ÿå‹•ï¼‰
```

---

## ğŸ‘¥ åœ˜éšŠ

- 111061223 æ±Ÿå“è±
- 111061155 æ—å·ç¥
- 111061233 å­”ç¥¥æœ‰

---

## ğŸ“– åƒè€ƒæ–‡ä»¶

- [åŸèªéŸ³ç³»çµ± README](README.md)
- [å¯¦é©—è¨˜éŒ„](docs/)
- [æ•´åˆè¨ˆç•«](C:\Users\user\.claude\plans\snuggly-cooking-pond.md)
- [é€²åº¦è¿½è¹¤](great_merge.md)

---

**ğŸ‰ Enjoy the game!**
